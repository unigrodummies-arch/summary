<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        .card-custom { background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 20px; border: none; }
    </style>
</head>
<body>

<div class="container" style="max-width: 1000px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/reports" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i> Back to Reports</a>
            <h4 class="d-inline-block align-middle text-secondary ms-2 m-0">Product Search</h4>
        </div>
        <div class="small text-muted">Find a product to view its history</div>
    </div>

    <div class="card-custom mb-4">
        <form id="searchForm" class="d-flex gap-2">
            <input type="text" id="searchTerm" class="form-control" placeholder="Enter Product Name, Internal Ref, or Barcode..." required autofocus>
            <button type="submit" class="btn btn-primary fw-bold px-4">
                <i class="fas fa-search me-2"></i> Search
            </button>
        </form>
    </div>

    <div class="card-custom">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Internal Ref</th>
                    <th>Product Name</th>
                    <th>Barcode</th>
                    <th class="text-end">Price</th>
                    <th class="text-center" style="width: 150px;">Action</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <tr><td colspan="5" class="text-center text-muted py-5">Enter a search term above</td></tr>
            </tbody>
        </table>
    </div>

</div>

<div id="loading" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none d-flex justify-content-center align-items-center" style="z-index: 2000;">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<script>
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const term = document.getElementById('searchTerm').value;
        if(!term) return;

        document.getElementById('loading').classList.remove('d-none');
        try {
            const res = await fetch('/api/search_product', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ term: term })
            });
            const data = await res.json();
            
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            if(data.products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No products found</td></tr>';
            } else {
                data.products.forEach(p => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="font-monospace small text-muted">${p.default_code || '-'}</td>
                            <td class="fw-bold text-primary">${p.name}</td>
                            <td class="font-monospace small">${p.barcode || '-'}</td>
                            <td class="text-end">${parseFloat(p.list_price).toLocaleString('en-US', {minimumFractionDigits:2})}</td>
                            <td class="text-center">
                                <a href="/product_history/${p.id}?name=${encodeURIComponent(p.name)}" class="btn btn-sm btn-outline-dark rounded-pill px-3">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </td>
                        </tr>
                    `;
                });
            }
        } catch(err) {
            alert("Connection Error");
        } finally {
            document.getElementById('loading').classList.add('d-none');
        }
    });
</script>
</body>
</html>