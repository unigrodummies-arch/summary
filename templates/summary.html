<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales & Payment Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        
        /* Card & UI Styles */
        .summary-card { border: none; border-radius: 8px; color: white; transition: transform 0.2s; min-height: 90px; }
        .bg-gross { background: linear-gradient(135deg, #4e54c8, #8f94fb); }
        .bg-disc { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .bg-ret { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
        .bg-net { background: linear-gradient(135deg, #56ab2f, #a8e063); color: #333 !important; }
        .card-custom { background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 15px; border: none; margin-bottom: 15px; }
        .payment-bar { display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-around; align-items: center; }
        .pay-item { text-align: center; padding: 5px 15px; border-right: 1px solid #eee; flex: 1; }
        .pay-label { font-size: 0.75rem; text-transform: uppercase; color: #777; font-weight: 700; }
        .pay-val { font-size: 1.1rem; font-weight: bold; color: #333; }
        .dept-list { list-style: none; padding: 0; margin: 0; }
        .dept-list li { padding: 4px 10px; border-bottom: 1px dashed #f5f5f5; display: flex; justify-content: space-between; font-size: 0.85rem; }
        .dept-header { padding: 8px 10px; font-weight: bold; border-bottom: 1px solid #eee; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        
        /* Headers Colors */
        .dh-sales { background-color: #e3f2fd; color: #0d6efd; }
        .dh-disc { background-color: #e8f5e9; color: #198754; }
        .dh-due { background-color: #fbecec; color: #dc3545; }
        .dh-ret { background-color: #fff3cd; color: #ffc107; }

        /* Table */
        .table th { background-color: #343a40 !important; color: white; font-weight: 500; font-size: 0.8rem; padding: 8px; cursor: pointer; user-select: none; }
        .table td { font-size: 0.8rem; padding: 4px 6px; }
        td:nth-child(n+3), th:nth-child(n+3) { text-align: right; }
        .final-total-row td { background-color: #343a40 !important; color: white !important; font-weight: bold; border-top: 2px solid #000; }

        /* Print Styles */
        @media print {
            @page { margin: 5mm; size: landscape; }
            body { background-color: white; -webkit-print-color-adjust: exact; zoom: 90%; }
            .no-print, #setupSection, .btn, #loading, .home-btn-container { display: none !important; }
            .container-fluid { width: 100% !important; max-width: 100% !important; padding: 0 !important; }
            .card-custom { box-shadow: none; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; break-inside: auto; }
            .dept-card, .summary-card, .payment-bar { break-inside: avoid; }
            .row { margin-bottom: 10px; }
            #printHeader { display: block !important; margin-bottom: 5px; text-align: center; border-bottom: 2px solid #333; padding-bottom: 5px; }
            .table { width: 100%; margin-top: 5px; }
            thead { display: table-header-group; }
            tr { break-inside: avoid; page-break-inside: avoid; }
            .fa-sort, .fa-sort-up, .fa-sort-down { display: none; }
        }
        #printHeader { display: none; }
    </style>
</head>
<body>

<div class="container-fluid" style="max-width: 1400px;">
    
    <div class="mb-3 home-btn-container d-flex justify-content-between">
        <a href="/" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i> Back to Home</a>
    </div>
    
    <div class="card-custom mb-4" id="setupSection">
        <h5 class="text-secondary mb-3"><i class="fas fa-chart-line me-2"></i>Sales Dashboard Generator</h5>
        
        <div class="row g-2 align-items-end">
            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted mb-1">From</label>
                <input type="date" class="form-control form-control-sm" id="startDate" required>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted mb-1">To</label>
                <input type="date" class="form-control form-control-sm" id="endDate" required>
            </div>

            <div class="col-md-2">
                <button onclick="generateFromOdoo()" class="btn btn-warning btn-sm w-100 fw-bold shadow-sm" style="height: 31px;">
                    <i class="fas fa-bolt me-1"></i> Auto-Generate from Odoo
                </button>
            </div>

            <div class="col-md-1 text-center text-muted small pt-1">OR</div>

            <div class="col-md-5">
                <form id="uploadForm" class="row g-1">
                    <div class="col-4">
                        <label class="small text-muted mb-0">Sales</label>
                        <input type="file" class="form-control form-control-sm" id="salesFile" required>
                    </div>
                    <div class="col-4">
                        <label class="small text-muted mb-0">Payments</label>
                        <input type="file" class="form-control form-control-sm" id="paymentsFile" required>
                    </div>
                    <div class="col-4">
                        <label class="small text-muted mb-0">Returns</label>
                        <div class="input-group input-group-sm">
                            <input type="file" class="form-control" id="returnsFile" required>
                            <button type="submit" class="btn btn-primary fw-bold">Go</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center d-none my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted" id="loadingText">Processing...</p>
    </div>

    <div id="reportSection" class="d-none">
        <div id="printHeader">
            <h3>Sales Summary</h3>
            <p id="printPeriod">Period: - to -</p>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-md-3 col-6"><div class="card summary-card bg-gross p-2 ps-3"><span class="small opacity-75 text-uppercase">Gross Sales</span><h4 class="fw-bold mb-0" id="valGross">0.00</h4></div></div>
            <div class="col-md-3 col-6"><div class="card summary-card bg-disc p-2 ps-3"><span class="small opacity-75 text-uppercase">Discounts</span><h4 class="fw-bold mb-0" id="valDisc">0.00</h4></div></div>
            <div class="col-md-3 col-6"><div class="card summary-card bg-ret p-2 ps-3"><span class="small opacity-75 text-uppercase">Returns</span><h4 class="fw-bold mb-0" id="valRet">0.00</h4></div></div>
            <div class="col-md-3 col-6"><div class="card summary-card bg-net p-2 ps-3"><span class="small opacity-75 text-uppercase">Net Sales</span><h4 class="fw-bold mb-0" id="valNet">0.00</h4></div></div>
        </div>

        <div class="card-custom mb-3 py-2"><div class="payment-bar" id="paymentContainer"></div></div>

        <div class="row g-2 mb-3">
            <div class="col-md-3"><div class="card-custom dept-card p-0"><div class="dept-header dh-sales">Dept. Net Sales</div><ul class="dept-list" id="listSales"></ul></div></div>
            <div class="col-md-3"><div class="card-custom dept-card p-0"><div class="dept-header dh-disc">Dept. Discounts</div><ul class="dept-list" id="listDisc"></ul></div></div>
            <div class="col-md-3"><div class="card-custom dept-card p-0"><div class="dept-header dh-due">Dept. Due (Credit)</div><ul class="dept-list" id="listDue"></ul></div></div>
            <div class="col-md-3"><div class="card-custom dept-card p-0"><div class="dept-header dh-ret">Dept. Returns</div><ul class="dept-list" id="listRet"></ul></div></div>
        </div>

        <div class="card-custom">
            <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                <h6 class="text-muted fw-bold m-0 small">TRANSACTION DETAILS <small class="fw-normal">(Click headers to sort)</small></h6>
                <button class="btn btn-sm btn-dark" onclick="window.print()">Print Report</button>
            </div>
            <table class="table table-hover table-bordered table-striped m-0" id="reportTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
        </div>
    </div>
</div>

<script>
    // Init Dates
    const d = new Date();
    document.getElementById('startDate').valueAsDate = new Date(d.getFullYear(), d.getMonth(), 1);
    document.getElementById('endDate').valueAsDate = new Date(d.getFullYear(), d.getMonth() + 1, 0);

    function toggleLoading(show, text="Processing...") {
        const el = document.getElementById('loading');
        document.getElementById('loadingText').innerText = text;
        if(show) { el.classList.remove('d-none'); document.getElementById('reportSection').classList.add('d-none'); }
        else { el.classList.add('d-none'); }
    }

    // --- 1. FILE UPLOAD HANDLER ---
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const formData = new FormData();
        formData.append('salesFile', document.getElementById('salesFile').files[0]);
        formData.append('paymentsFile', document.getElementById('paymentsFile').files[0]);
        formData.append('returnsFile', document.getElementById('returnsFile').files[0]);
        formData.append('startDate', start); formData.append('endDate', end);

        toggleLoading(true);
        try {
            const res = await fetch('/generate', { method: 'POST', body: formData });
            const result = await res.json();
            if(res.ok) renderDashboard(result, start, end);
            else alert('Error: ' + result.error);
        } catch(err) { alert('Connection Error'); }
        finally { toggleLoading(false); }
    });

    // --- 2. ODOO GENERATE HANDLER ---
    async function generateFromOdoo() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        
        toggleLoading(true, "Fetching data from Odoo...");
        try {
            const res = await fetch('/generate_from_odoo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ startDate: start, endDate: end })
            });
            const result = await res.json();
            
            if(res.ok) renderDashboard(result, start, end);
            else alert("Odoo Error: " + result.error);
        } catch(err) {
            console.error(err);
            alert("Connection Error. Check if Odoo is running.");
        } finally {
            toggleLoading(false);
        }
    }

    // --- RENDER & HELPERS ---
    function formatMoney(n) { return (typeof n === 'number') ? n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}) : n; }

    function renderDashboard(data, start, end) {
        document.getElementById('printPeriod').innerText = `Period: ${start} to ${end}`;

        // Top Cards
        const s = data.summary;
        document.getElementById('valGross').innerText = formatMoney(s.gross_sales);
        document.getElementById('valDisc').innerText = formatMoney(s.total_discount);
        document.getElementById('valRet').innerText = formatMoney(s.total_returns);
        document.getElementById('valNet').innerText = formatMoney(s.net_sales);

        // Payments
        const pContainer = document.getElementById('paymentContainer');
        pContainer.innerHTML = '';
        let totalRec = 0;
        for (const [method, val] of Object.entries(data.payment_summary)) {
            totalRec += val;
            pContainer.innerHTML += `<div class="pay-item"><div class="pay-label">${method}</div><div class="pay-val">${formatMoney(val)}</div></div>`;
        }
        pContainer.innerHTML += `<div class="pay-item"><div class="pay-label text-success">Total Collected</div><div class="pay-val total">${formatMoney(totalRec)}</div></div>`;
        pContainer.innerHTML += `<div class="pay-item"><div class="pay-label text-danger">Outstanding Due</div><div class="pay-val due">${formatMoney(data.total_due)}</div></div>`;

        // Depts
        function fillList(id, data, cls) {
            const el = document.getElementById(id); el.innerHTML = '';
            for(const [k,v] of Object.entries(data)) if(v!==0) el.innerHTML += `<li><span>${k}</span><span class="${cls}">${formatMoney(v)}</span></li>`;
        }
        fillList('listSales', data.dept_sales, 'text-primary');
        fillList('listDisc', data.dept_discount, 'text-success');
        fillList('listDue', data.dept_due, 'text-danger');
        fillList('listRet', data.dept_returns, 'text-warning');

        // Grid
        const { columns, data: rows, totals } = data;
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        thead.innerHTML = ''; tbody.innerHTML = ''; 

        // Headers
        let hRow = '<tr>';
        columns.forEach((col, index) => {
            hRow += `<th onclick="sortTable(${index})">${col} <i class="fas fa-sort text-muted small ms-1 opacity-25"></i></th>`;
        });
        thead.innerHTML = hRow + '</tr>';

        // Body
        rows.forEach(row => {
            let tr = '<tr>';
            columns.forEach(col => {
                let val = row[col];
                if (['Sales Value','Due','Return Value','Discount'].includes(col)) {
                    val = formatMoney(val);
                    if (col === 'Due' && row[col] > 0) val = `<span class="fw-bold text-danger">${val}</span>`;
                }
                tr += `<td>${val}</td>`;
            });
            tbody.innerHTML += tr + '</tr>';
        });

        // Totals
        let fRow = '<tr class="final-total-row">';
        columns.forEach(col => {
            let val = totals[col];
            if (typeof val === 'number') val = formatMoney(val);
            fRow += `<td>${val}</td>`;
        });
        tbody.innerHTML += fRow + '</tr>';

        document.getElementById('reportSection').classList.remove('d-none');
    }

    // --- SORTING ---
    let currentSort = { column: -1, direction: 'asc' };
    window.sortTable = function(colIndex) {
        const tbody = document.getElementById("tableBody");
        const rows = Array.from(tbody.rows);
        const dataRows = rows.filter(r => !r.classList.contains('final-total-row'));
        const totalRow = rows.find(r => r.classList.contains('final-total-row'));

        let dir = (currentSort.column === colIndex && currentSort.direction === 'asc') ? 'desc' : 'asc';
        currentSort = { column: colIndex, direction: dir };

        dataRows.sort((a, b) => {
            let x = a.getElementsByTagName("TD")[colIndex].innerText.trim().replace(/,/g, "");
            let y = b.getElementsByTagName("TD")[colIndex].innerText.trim().replace(/,/g, "");
            let xNum = parseFloat(x); let yNum = parseFloat(y);
            return (!isNaN(xNum) && !isNaN(yNum)) ? (dir === 'asc' ? xNum - yNum : yNum - xNum) : (dir === 'asc' ? x.localeCompare(y) : y.localeCompare(x));
        });

        tbody.innerHTML = "";
        dataRows.forEach(row => tbody.appendChild(row));
        if(totalRow) tbody.appendChild(totalRow);
        
        document.querySelectorAll("#tableHead th i").forEach(h => h.className = "fas fa-sort text-muted small ms-1 opacity-25");
        document.querySelectorAll("#tableHead th")[colIndex].querySelector("i").className = dir === 'asc' ? "fas fa-sort-up ms-1" : "fas fa-sort-down ms-1";
    }
</script>

</body>
</html>